<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mountain Rescue</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 50%, #8B4513 100%);
            height: 100vh;
            height: 100dvh;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #backButton {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        #backButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .game-container {
            width: min(900px, 95vw);
            height: min(600px, 85vh);
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            border: 3px solid #4facfe;
        }

        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            z-index: 10;
        }

        .start-screen h1 {
            font-size: 2.8rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 10px #4facfe; }
            to { text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 20px #4facfe, 0 0 30px #4facfe; }
        }

        .start-screen p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .start-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .instructions-popup {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }

        .instructions-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 30px;
            border-radius: 15px;
            color: white;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .instructions-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #4facfe;
        }

        .instructions-content p {
            font-size: 1.1rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .close-instructions {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .close-instructions:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .game-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        .game-viewport {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 20%, #98FB98 50%, #228B22 70%, #8B7355 85%, #654321 100%);
        }

        .game-world {
            position: absolute;
            width: 2000px;
            height: 1000px;
            transition: transform 0.3s ease;
        }

        .ground {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(180deg, #228B22 0%, #8B7355 50%, #654321 100%);
            z-index: -1;
        }

        .helicopter {
            position: absolute;
            width: 60px;
            height: 40px;
            background: transparent;
            border-radius: 10px;
            z-index: 10;
        }

        .helicopter::before {
            content: 'üöÅ';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 50px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .rope {
            position: absolute;
            left: 50%;
            top: 100%;
            width: 3px;
            background: linear-gradient(to bottom, #8B4513, #654321);
            transform: translateX(-50%);
            z-index: 5;
            box-shadow: 1px 0 2px rgba(0,0,0,0.3);
        }

        .mountain {
            position: absolute;
            background: linear-gradient(135deg, #696969, #A9A9A9);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .mountain.large {
            width: 200px;
            height: 180px;
        }

        .mountain.medium {
            width: 150px;
            height: 120px;
        }

        .mountain.small {
            width: 100px;
            height: 80px;
        }

        .mountain.xlarge {
            width: 280px;
            height: 250px;
        }

        .mountain.tiny {
            width: 60px;
            height: 50px;
        }

        @keyframes explosion {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        .helicopter.exploding {
            animation: explosion 0.5s ease-out;
        }

        .mountain.snow::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 30%;
            background: linear-gradient(135deg, #FFFFFF, #F0F8FF);
            clip-path: polygon(50% 0%, 20% 80%, 80% 80%);
            z-index: 2;
        }

        .mountain.rocky {
            background: linear-gradient(135deg, #8B4513, #A0522D);
        }

        .mountain.forest {
            background: linear-gradient(135deg, #228B22, #32CD32);
        }

        .person {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #FF69B4, #FF1493);
            border-radius: 50%;
            z-index: 8;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            animation: wave 2s ease-in-out infinite;
        }

        .person::before {
            content: 'üßó';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
        }

        .person.rescued {
            opacity: 0.3;
            animation: none;
        }

        @keyframes wave {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .cloud {
            position: absolute;
            background: transparent;
            border-radius: 50px;
            opacity: 0.9;
            z-index: 1;
        }

        .cloud::before {
            content: '‚òÅÔ∏è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
        }

        .hud {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            z-index: 15;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 10px;
        }

        .mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 10px;
            z-index: 15;
        }

        .control-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        .control-btn:active {
            background: rgba(255,255,255,0.4);
            transform: scale(0.95);
        }

        .wind-indicator {
            position: absolute;
            top: 60px;
            right: 20px;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 10px;
            z-index: 15;
        }

        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            z-index: 30;
        }

        .game-over h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #4facfe;
        }

        .game-over p {
            font-size: 1.3rem;
            margin-bottom: 30px;
        }

        .restart-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: grid;
            }
            
            .game-container {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <button id="backButton">‚Üê Back to Hub</button>
    
    <div class="game-container">
        <div class="start-screen" id="startScreen">
            <h1>üöÅ Mountain Rescue</h1>
            <p>Pilot your helicopter to rescue stranded climbers!</p>
            <button class="start-btn" id="startBtn">Take Flight</button>
        </div>

        <div class="instructions-popup" id="instructionsPopup">
            <div class="instructions-content">
                <h2>üöÅ Mission Briefing</h2>
                <p><strong>üéØ Your Mission:</strong> Rescue all climbers using your helicopter!</p>
                <p><strong>üéÆ Controls:</strong> WASD or Arrow Keys to fly</p>
                <p><strong>ü™¢ Rescue Method:</strong> Lower your rope to touch trapped climbers</p>
                <p><strong>‚ö†Ô∏è Watch Out:</strong> Strong winds in later levels will affect your flight!</p>
                <button class="close-instructions" id="closeInstructions">Roger! Let's Rescue!</button>
            </div>
        </div>

        <div class="game-area" id="gameArea">
            <div class="game-viewport" id="gameViewport">
                <div class="game-world" id="gameWorld">
                    <!-- Game elements will be generated here -->
                </div>
            </div>
            
            <div class="hud" id="hud">
                <div>Level: <span id="currentLevel">1</span></div>
                <div>Rescued: <span id="rescuedCount">0</span>/<span id="totalPeople">3</span></div>
                <div>Altitude: <span id="altitude">0</span>m</div>
            </div>

            <div class="wind-indicator" id="windIndicator" style="display: none;">
                <div>Wind: <span id="windDirection">‚Üí</span> <span id="windStrength">0</span></div>
            </div>

            <div class="mobile-controls" id="mobileControls">
                <div></div>
                <div class="control-btn" id="upBtn">‚Üë</div>
                <div></div>
                <div class="control-btn" id="leftBtn">‚Üê</div>
                <div></div>
                <div class="control-btn" id="rightBtn">‚Üí</div>
                <div></div>
                <div class="control-btn" id="downBtn">‚Üì</div>
                <div></div>
            </div>
        </div>

        <div class="game-over" id="gameOver">
            <h2>Mission Complete!</h2>
            <p id="gameOverText">All climbers rescued successfully!</p>
            <button class="restart-btn" id="restartBtn">Next Mission</button>
        </div>
    </div>

    <script>
        class MountainRescue {
            constructor() {
                this.gameArea = document.getElementById('gameArea');
                this.gameWorld = document.getElementById('gameWorld');
                this.gameViewport = document.getElementById('gameViewport');
                this.startScreen = document.getElementById('startScreen');
                this.instructionsPopup = document.getElementById('instructionsPopup');
                this.gameOver = document.getElementById('gameOver');
                this.gameOverText = document.getElementById('gameOverText');
                
                this.currentLevelSpan = document.getElementById('currentLevel');
                this.rescuedCountSpan = document.getElementById('rescuedCount');
                this.totalPeopleSpan = document.getElementById('totalPeople');
                this.altitudeSpan = document.getElementById('altitude');
                this.windIndicator = document.getElementById('windIndicator');
                this.windDirection = document.getElementById('windDirection');
                this.windStrength = document.getElementById('windStrength');

                this.currentLevel = 1;
                this.maxLevel = 5;
                this.rescuedCount = 0;
                this.totalPeople = 3;
                this.isMoving = false;

                // Helicopter properties
                this.helicopter = {
                    x: 100,
                    y: 200, // Start at appropriate height for shorter world
                    speed: 3,
                    ropeLength: 0,
                    maxRopeLength: 150
                };

                // Camera properties
                this.camera = {
                    x: 0,
                    y: 0,
                    targetX: 0,
                    targetY: 0,
                    smoothing: 0.1
                };

                // Wind properties
                this.wind = {
                    strength: 0,
                    direction: { x: 0, y: 0 },
                    active: false
                };

                this.people = [];
                this.mountains = [];
                this.clouds = [];
                this.keys = {};

                this.setupEventListeners();
                this.showInstructions();
            }

            setupEventListeners() {
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.hideInstructions();
                });

                document.getElementById('closeInstructions').addEventListener('click', () => {
                    this.hideInstructions();
                });

                document.getElementById('restartBtn').addEventListener('click', () => {
                    this.nextLevel();
                });

                document.getElementById('backButton').addEventListener('click', () => {
                    window.location.href = 'home.html';
                });

                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    // Handle spacebar for instructions popup
                    if (e.key === ' ' && this.instructionsPopup.style.display === 'flex') {
                        e.preventDefault();
                        this.hideInstructions();
                        return;
                    }

                    // Handle spacebar for start screen
                    if (e.key === ' ' && this.startScreen.style.display === 'flex') {
                        e.preventDefault();
                        this.hideInstructions();
                        return;
                    }

                    if (this.gameArea.style.display === 'block') {
                        this.keys[e.key.toLowerCase()] = true;
                        if (e.key === ' ') {
                            e.preventDefault();
                            this.resetLevel();
                        }
                    }

                    if (e.key === ' ' && this.gameOver.style.display === 'flex') {
                        e.preventDefault();
                        this.nextLevel();
                    }
                });

                document.addEventListener('keyup', (e) => {
                    this.keys[e.key.toLowerCase()] = false;
                });

                // Mobile controls
                const controlButtons = {
                    upBtn: () => this.moveHelicopter(0, -1),
                    downBtn: () => this.moveHelicopter(0, 1),
                    leftBtn: () => this.moveHelicopter(-1, 0),
                    rightBtn: () => this.moveHelicopter(1, 0)
                };

                Object.entries(controlButtons).forEach(([id, action]) => {
                    const btn = document.getElementById(id);
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.keys[id] = true;
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.keys[id] = false;
                    });
                });

                // Touch controls for mobile
                if ('ontouchstart' in window) {
                    document.getElementById('mobileControls').style.display = 'grid';
                }
            }

            showInstructions() {
                this.instructionsPopup.style.display = 'flex';
            }

            hideInstructions() {
                this.instructionsPopup.style.display = 'none';
                this.startGame();
            }

            startGame() {
                this.startScreen.style.display = 'none';
                this.gameArea.style.display = 'block';
                this.loadLevel(this.currentLevel);
                this.gameLoop();
                this.playSound(440, 100);
            }

            loadLevel(levelNum) {
                // Reset game state
                this.helicopter = {
                    x: 100,
                    y: 200, // Start at appropriate height for shorter world
                    speed: 3,
                    ropeLength: 0,
                    maxRopeLength: 150
                };
                
                this.camera = {
                    x: 0,
                    y: 0,
                    targetX: 0,
                    targetY: 0,
                    smoothing: 0.1
                };

                this.rescuedCount = 0;
                this.totalPeople = 3 + (levelNum - 1);
                this.people = [];
                this.mountains = [];
                this.clouds = [];

                // Setup wind for levels 3+
                if (levelNum >= 3) {
                    this.wind.active = true;
                    this.wind.strength = (levelNum - 2) * 5; // Increased wind strength
                    this.wind.direction = {
                        x: (Math.random() - 0.5) * 2,
                        y: (Math.random() - 0.5) * 0.5
                    };
                    this.windIndicator.style.display = 'block';
                } else {
                    this.wind.active = false;
                    this.windIndicator.style.display = 'none';
                }

                this.generateLevel(levelNum);
                this.updateUI();
                this.renderLevel();
            }

            generateLevel(levelNum) {
                // Generate mountains - positioned closer to top and sitting on ground
                const mountainCount = 4 + levelNum;
                for (let i = 0; i < mountainCount; i++) {
                    const mountainTypes = ['snow', 'rocky', 'forest', ''];
                    const sizeTypes = ['tiny', 'small', 'medium', 'large', 'xlarge'];
                    
                    // Create weighted distribution for more variety
                    const sizeWeights = [0.1, 0.3, 0.4, 0.15, 0.05]; // tiny, small, medium, large, xlarge
                    let random = Math.random();
                    let sizeIndex = 0;
                    let cumulative = 0;
                    
                    for (let j = 0; j < sizeWeights.length; j++) {
                        cumulative += sizeWeights[j];
                        if (random <= cumulative) {
                            sizeIndex = j;
                            break;
                        }
                    }
                    
                    // Reduced height range for faster gameplay
                    const baseHeight = [50, 80, 120, 180, 250][sizeIndex]; // Heights for each size
                    const height = baseHeight + Math.random() * 30; // Small random variation
                    
                    const mountain = {
                        x: 200 + i * 250 + Math.random() * 100,
                        y: 900 - height, // Position so mountain sits on smaller ground level
                        width: [60, 100, 150, 200, 280][sizeIndex] + Math.random() * 30,
                        height: height,
                        size: sizeTypes[sizeIndex],
                        type: mountainTypes[Math.floor(Math.random() * mountainTypes.length)]
                    };
                    this.mountains.push(mountain);
                }

                // Generate people on mountains - positioned properly on mountain surface
                for (let i = 0; i < this.totalPeople; i++) {
                    const mountain = this.mountains[Math.floor(Math.random() * this.mountains.length)];
                    // Calculate proper position on mountain slope (triangular shape)
                    const relativeX = 0.2 + Math.random() * 0.6; // 20-80% across mountain width
                    // For a triangle with apex at center, height at any x position
                    const distanceFromCenter = Math.abs(relativeX - 0.5) * 2; // 0 at center, 1 at edges
                    const heightAtPosition = mountain.height * (1 - distanceFromCenter);
                    
                    const person = {
                        x: mountain.x + mountain.width * relativeX - 10, // Center the person sprite
                        y: mountain.y + mountain.height - heightAtPosition - 15, // Place on the slope surface, offset for sprite
                        rescued: false,
                        climbingToHelicopter: false
                    };
                    this.people.push(person);
                }

                // Generate clouds - positioned lower in the shorter world
                const cloudCount = 3 + levelNum;
                for (let i = 0; i < cloudCount; i++) {
                    const cloud = {
                        x: Math.random() * 1800,
                        y: 100 + Math.random() * 300, // Clouds between y=100 and y=400
                        width: 60 + Math.random() * 40,
                        height: 40 + Math.random() * 20
                    };
                    this.clouds.push(cloud);
                }
            }

            renderLevel() {
                // Clear game world
                this.gameWorld.innerHTML = '';

                // Render ground
                const groundEl = document.createElement('div');
                groundEl.className = 'ground';
                groundEl.style.width = '2000px';
                groundEl.style.height = '100px';
                groundEl.style.bottom = '0px';
                groundEl.style.left = '0px';
                this.gameWorld.appendChild(groundEl);

                // Render clouds
                this.clouds.forEach(cloud => {
                    const cloudEl = document.createElement('div');
                    cloudEl.className = 'cloud';
                    cloudEl.style.left = cloud.x + 'px';
                    cloudEl.style.top = cloud.y + 'px';
                    cloudEl.style.width = cloud.width + 'px';
                    cloudEl.style.height = cloud.height + 'px';
                    this.gameWorld.appendChild(cloudEl);
                });

                // Render mountains
                this.mountains.forEach(mountain => {
                    const mountainEl = document.createElement('div');
                    mountainEl.className = `mountain ${mountain.size} ${mountain.type}`;
                    mountainEl.style.left = mountain.x + 'px';
                    mountainEl.style.top = mountain.y + 'px';
                    mountainEl.style.width = mountain.width + 'px';
                    mountainEl.style.height = mountain.height + 'px';
                    this.gameWorld.appendChild(mountainEl);
                });

                // Render people
                this.people.forEach(person => {
                    const personEl = document.createElement('div');
                    personEl.className = `person ${person.rescued ? 'rescued' : ''}`;
                    personEl.style.left = person.x + 'px';
                    personEl.style.top = person.y + 'px';
                    this.gameWorld.appendChild(personEl);
                });

                // Render helicopter
                const helicopterEl = document.createElement('div');
                helicopterEl.className = 'helicopter';
                helicopterEl.id = 'helicopter';
                helicopterEl.style.left = this.helicopter.x + 'px';
                helicopterEl.style.top = this.helicopter.y + 'px';
                this.gameWorld.appendChild(helicopterEl);

                // Render rope
                const ropeEl = document.createElement('div');
                ropeEl.className = 'rope';
                ropeEl.id = 'rope';
                ropeEl.style.left = (this.helicopter.x + 30) + 'px';
                ropeEl.style.top = (this.helicopter.y + 40) + 'px';
                ropeEl.style.height = this.helicopter.ropeLength + 'px';
                this.gameWorld.appendChild(ropeEl);
            }

            gameLoop() {
                if (this.gameArea.style.display === 'block') {
                    this.update();
                    this.render();
                    requestAnimationFrame(() => this.gameLoop());
                }
            }

            update() {
                // Handle helicopter movement
                let moveX = 0;
                let moveY = 0;

                if (this.keys['w'] || this.keys['arrowup'] || this.keys['upBtn']) {
                    moveY -= this.helicopter.speed;
                }
                if (this.keys['s'] || this.keys['arrowdown'] || this.keys['downBtn']) {
                    moveY += this.helicopter.speed;
                }
                if (this.keys['a'] || this.keys['arrowleft'] || this.keys['leftBtn']) {
                    moveX -= this.helicopter.speed;
                }
                if (this.keys['d'] || this.keys['arrowright'] || this.keys['rightBtn']) {
                    moveX += this.helicopter.speed;
                }

                // Apply wind effect
                if (this.wind.active) {
                    moveX += this.wind.direction.x * this.wind.strength * 0.2; // Increased wind effect
                    moveY += this.wind.direction.y * this.wind.strength * 0.2;
                }

                // Update helicopter position
                this.helicopter.x = Math.max(0, Math.min(1940, this.helicopter.x + moveX));
                this.helicopter.y = Math.max(0, Math.min(800, this.helicopter.y + moveY)); // Adjusted for shorter world

                // Check for collisions with ground or mountains
                this.checkCollisions();

                // Smart rope extension - only when above a person needing rescue
                this.updateRope();

                // Check for rescues
                this.checkRescues();

                // Update camera
                this.updateCamera();

                // Update wind indicator
                this.updateWindIndicator();

                // Check level completion
                if (this.rescuedCount >= this.totalPeople) {
                    this.completeLevel();
                }
            }

            checkRescues() {
                const ropeEndX = this.helicopter.x + 30;
                const ropeEndY = this.helicopter.y + 40 + this.helicopter.ropeLength;

                this.people.forEach(person => {
                    if (!person.rescued && !person.climbingToHelicopter) {
                        const distance = Math.sqrt(
                            Math.pow(ropeEndX - person.x - 10, 2) + 
                            Math.pow(ropeEndY - person.y - 10, 2)
                        );

                        if (distance < 25) {
                            person.climbingToHelicopter = true;
                            this.rescuePerson(person);
                        }
                    }
                });
            }

            checkCollisions() {
                const helicopterCenterX = this.helicopter.x + 30;
                const helicopterCenterY = this.helicopter.y + 20;
                const helicopterBottom = this.helicopter.y + 40;

                // Check collision with ground (bottom 100px of world)
                if (helicopterBottom >= 900) {
                    this.helicopterCrash();
                    return;
                }

                // Check collision with mountains
                this.mountains.forEach(mountain => {
                    // Check if helicopter is within mountain x bounds
                    if (helicopterCenterX >= mountain.x && 
                        helicopterCenterX <= mountain.x + mountain.width) {
                        
                        // Calculate mountain height at helicopter position (triangular shape)
                        const relativeX = (helicopterCenterX - mountain.x) / mountain.width;
                        const distanceFromCenter = Math.abs(relativeX - 0.5) * 2;
                        const heightAtPosition = mountain.height * (1 - distanceFromCenter);
                        const mountainTopY = mountain.y + mountain.height - heightAtPosition;

                        // Check if helicopter collides with mountain
                        if (helicopterBottom >= mountainTopY) {
                            this.helicopterCrash();
                            return;
                        }
                    }
                });
            }

            updateRope() {
                const helicopterCenterX = this.helicopter.x + 30;
                const helicopterCenterY = this.helicopter.y + 20;
                
                // Check if helicopter is above any unrescued person
                let abovePerson = false;
                
                this.people.forEach(person => {
                    if (!person.rescued && !person.climbingToHelicopter) {
                        // Check if helicopter is roughly above this person
                        const horizontalDistance = Math.abs(helicopterCenterX - (person.x + 10));
                        const verticalDistance = helicopterCenterY - person.y;
                        
                        // If helicopter is above and within reasonable horizontal range
                        if (horizontalDistance < 40 && verticalDistance < 0) {
                            abovePerson = true;
                        }
                    }
                });
                
                // Extend rope if above person, retract if not
                if (abovePerson && this.helicopter.ropeLength < this.helicopter.maxRopeLength) {
                    this.helicopter.ropeLength = Math.min(this.helicopter.maxRopeLength, this.helicopter.ropeLength + 3);
                } else if (!abovePerson && this.helicopter.ropeLength > 0) {
                    this.helicopter.ropeLength = Math.max(0, this.helicopter.ropeLength - 3);
                }
            }

            helicopterCrash() {
                // Play crash sound
                this.playSound(150, 300, 'sawtooth');
                
                // Show explosion effect
                this.showExplosion();
                
                // Reset level after short delay
                setTimeout(() => {
                    this.resetLevel();
                }, 1000);
            }

            showExplosion() {
                // Create explosion visual effect
                const helicopterEl = document.getElementById('helicopter');
                if (helicopterEl) {
                    helicopterEl.innerHTML = 'üí•';
                    helicopterEl.style.fontSize = '60px';
                    helicopterEl.classList.add('exploding');
                }
            }

            rescuePerson(person) {
                person.rescued = true;
                this.rescuedCount++;
                this.playSound(660, 200);
                this.updateUI();

                // Visual feedback - person climbs up
                setTimeout(() => {
                    person.climbingToHelicopter = false;
                }, 1000);
            }

            updateCamera() {
                // Follow helicopter - center it better for mountain rescue action
                this.camera.targetX = this.helicopter.x - 420;
                this.camera.targetY = this.helicopter.y - 100; // Adjusted for shorter world

                // More responsive camera movement
                this.camera.x += (this.camera.targetX - this.camera.x) * 0.15;
                this.camera.y += (this.camera.targetY - this.camera.y) * 0.15;

                // Constrain camera to world bounds (world: 2000x1000, viewport: ~900x600)
                this.camera.x = Math.max(0, Math.min(1100, this.camera.x));
                this.camera.y = Math.max(0, Math.min(400, this.camera.y)); // Adjusted for shorter world
            }

            updateWindIndicator() {
                if (this.wind.active) {
                    const directions = ['‚Üê', '‚Üñ', '‚Üë', '‚Üó', '‚Üí', '‚Üò', '‚Üì', '‚Üô'];
                    const angle = Math.atan2(this.wind.direction.y, this.wind.direction.x);
                    const index = Math.round(((angle + Math.PI) / (2 * Math.PI)) * 8) % 8;
                    this.windDirection.textContent = directions[index];
                    this.windStrength.textContent = Math.round(this.wind.strength);
                }
            }

            render() {
                // Update camera transform
                this.gameWorld.style.transform = `translate(-${this.camera.x}px, -${this.camera.y}px)`;

                // Update helicopter position
                const helicopterEl = document.getElementById('helicopter');
                if (helicopterEl) {
                    helicopterEl.style.left = this.helicopter.x + 'px';
                    helicopterEl.style.top = this.helicopter.y + 'px';
                }

                // Update rope
                const ropeEl = document.getElementById('rope');
                if (ropeEl) {
                    ropeEl.style.left = (this.helicopter.x + 30) + 'px';
                    ropeEl.style.top = (this.helicopter.y + 40) + 'px';
                    ropeEl.style.height = this.helicopter.ropeLength + 'px';
                }

                // Update people positions (climbing animation)
                const personEls = document.querySelectorAll('.person');
                this.people.forEach((person, index) => {
                    if (personEls[index]) {
                        personEls[index].style.left = person.x + 'px';
                        personEls[index].style.top = person.y + 'px';
                        if (person.rescued) {
                            personEls[index].classList.add('rescued');
                        }
                    }
                });

                // Update altitude
                const altitude = Math.max(0, Math.round((1200 - this.helicopter.y) / 10));
                this.altitudeSpan.textContent = altitude;
            }

            completeLevel() {
                if (this.currentLevel >= this.maxLevel) {
                    this.gameOverText.textContent = `Mission Complete! You've rescued everyone across all ${this.maxLevel} mountain ranges!`;
                    document.getElementById('restartBtn').textContent = 'Play Again';
                } else {
                    this.gameOverText.textContent = `Level ${this.currentLevel} Complete! ${this.rescuedCount} climbers rescued safely!`;
                    document.getElementById('restartBtn').textContent = 'Next Mission';
                }
                this.gameOver.style.display = 'flex';
                this.playSound(880, 500);
            }

            nextLevel() {
                this.gameOver.style.display = 'none';
                if (this.currentLevel >= this.maxLevel) {
                    this.currentLevel = 1;
                } else {
                    this.currentLevel++;
                }
                this.loadLevel(this.currentLevel);
            }

            resetLevel() {
                this.loadLevel(this.currentLevel);
                this.playSound(220, 100);
            }

            updateUI() {
                this.currentLevelSpan.textContent = this.currentLevel;
                this.rescuedCountSpan.textContent = this.rescuedCount;
                this.totalPeopleSpan.textContent = this.totalPeople;
            }

            playSound(frequency, duration, type = 'sine') {
                try {
                    // Create or reuse AudioContext
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    // Resume context if it's suspended (required in some browsers)
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.type = type;
                    
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration / 1000);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + duration / 1000);
                } catch (e) {
                    // Audio not available
                }
            }
        }

        // Start the game
        const game = new MountainRescue();

        window.addEventListener("load", function() {
            setTimeout(() => {
                window.scrollTo(0, 1);
            }, 100);
        });
    </script>
</body>
</html>
