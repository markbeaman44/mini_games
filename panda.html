<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silly Bamboo Collect — Playable Kids Game</title>
  <style>
    :root{
      --bg:#a6e3ff;
      --ground:#7bb26b;
      --panel:#ffffffcc;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',Arial}
    .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box;background:linear-gradient(180deg,var(--bg),#d0f7ff)}
    .game{width:min(960px,98vw);height:min(640px,92vh);background:linear-gradient(#dff7ff, #eafcf7);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.15);position:relative;overflow:hidden}
    header{position:absolute;left:14px;top:12px;z-index:10;display:flex;gap:10px;align-items:center}
    .panel{background:var(--panel);padding:8px 12px;border-radius:12px;font-weight:700;display:flex;gap:8px;align-items:center}
    .score{font-size:18px}
    canvas{display:block;width:100%;height:100%}
    /* controls for touch */
    .controls{position:absolute;left:12px;bottom:12px;z-index:12;display:flex;gap:12px}
    .bigbtn{width:72px;height:72px;border-radius:18px;background:#fff8;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-size:24px;backdrop-filter:blur(4px);box-shadow:0 6px 16px rgba(0,0,0,0.12)}
    .bigbtn:active{transform:translateY(2px)}
    .centerMsg{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:11;background:linear-gradient(#fff8,#fff4);padding:18px;border-radius:14px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
    .startBtn{margin-top:12px;padding:10px 18px;border-radius:12px;font-weight:800;border:0;background:#ff6b6b;color:white;font-size:18px}
    .footer-note{position:absolute;right:12px;bottom:12px;font-size:12px;color:#064}
    #backButton {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease, transform 0.2s ease;
      z-index: 1000;
    }
    #backButton:hover {
      background: #ff5252;
      transform: translateY(-2px);
    }
    #backButton:active {
      transform: translateY(0);
    }
    @media (max-width:600px){.bigbtn{width:62px;height:62px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="game" id="gameRoot">
      <button id="backButton">← Back to Hub</button>
      <header>
        <div class="panel">Level: <span id="level">1</span></div>
        <div class="panel">Lanterns: <span id="score" class="score">0</span>/<span id="totalLanterns">6</span></div>
      </header>

      <div class="centerMsg" id="overlay">
        <h2 style="margin:0 0 6px 0">Silly Bamboo Collect</h2>
        <div>A friendly panda wants lanterns! Move, jump, and collect 6 lanterns.</div>
        <button class="startBtn" id="startBtn">Start Game</button>
      </div>

      <canvas id="c"></canvas>

      <div class="controls" id="touchControls" style="display:none;">
        <div class="bigbtn" id="leftBtn">◀</div>
        <div class="bigbtn" id="jumpBtn">⤒</div>
        <div class="bigbtn" id="rightBtn">▶</div>
      </div>

      <div class="footer-note">Theme: Asia — for ages 4–6 • Tap to play on phones</div>
    </div>
  </div>

<script>
(() => {
  // Canvas setup
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  let W = canvas.width = 960;
  let H = canvas.height = 640;

  const scoreEl = document.getElementById('score');
  const levelEl = document.getElementById('level');
  const totalLanternsEl = document.getElementById('totalLanterns');
  const overlay = document.getElementById('overlay');
  const startBtn = document.getElementById('startBtn');

  const touchControls = document.getElementById('touchControls');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const jumpBtn = document.getElementById('jumpBtn');
  const backBtn = document.getElementById('backButton');

  let isTouch = 'ontouchstart' in window || navigator.maxTouchPoints>0;
  if(isTouch) touchControls.style.display = 'flex';

  // game state
  let keys = {left:false,right:false,jump:false};
  let score = 0;
  let gameRunning = false;
  let currentLevel = 1;

  // world
  const gravity = 0.9;
  let platforms = [];
  let lanterns = [];

  // panda
  const panda = {
    x:120, y:0, vx:0, vy:0, w:80, h:72, onGround:false, tilt:0, eyeOffset:0
  };

  // helpers
  function resize() {
    const rect = canvas.getBoundingClientRect();
    W = canvas.width = Math.max(480, Math.floor(rect.width));
    H = canvas.height = Math.max(320, Math.floor(rect.height));
  }
  window.addEventListener('resize', resize);
  resize();

  function resetGame(){
    score = 0;
    scoreEl.textContent = score;
    levelEl.textContent = currentLevel;
    panda.x = 120; panda.y = 150; panda.vx=0; panda.vy=0; panda.onGround=false;
    generateLevel(currentLevel);
    totalLanternsEl.textContent = lanterns.length;
  }

  function generateLevel(level) {
    // Base platforms that are always present
    platforms = [
      {x:0,y:H-80,w:W,h:80}, // ground
      {x:90,y:H-200,w:220,h:18},
      {x:360,y:H-300,w:200,h:18},
      {x:640,y:H-240,w:220,h:18},
    ];

    // Add additional platforms for higher levels
    if(level >= 2) {
      platforms.push({x:150,y:H-380,w:180,h:18}); // higher platform
    }
    if(level >= 3) {
      platforms.push({x:500,y:H-420,w:160,h:18}); // even higher
      platforms.push({x:750,y:H-180,w:180,h:18}); // right side platform
    }
    if(level >= 4) {
      platforms.push({x:20,y:H-320,w:140,h:18}); // left side high
      platforms.push({x:680,y:H-360,w:160,h:18}); // right side high
    }
    if(level >= 5) {
      platforms.push({x:300,y:H-480,w:200,h:18}); // top center
      platforms.push({x:80,y:H-440,w:120,h:18}); // left high
    }

    // Generate lanterns - base amount + level
    const lanternCount = 5 + level; // Start with 6 lanterns in level 1, then 7, 8, etc.
    lanterns = [];
    
    for(let i = 0; i < lanternCount; i++) {
      let platformIndex, offsetX, offsetY;
      
      // Distribute lanterns across available platforms (skip ground platform)
      if(i < platforms.length - 1) {
        // First lanterns go on different platforms
        platformIndex = 1 + (i % (platforms.length - 1));
      } else {
        // Additional lanterns get distributed randomly across platforms
        platformIndex = 1 + Math.floor(Math.random() * (platforms.length - 1));
      }
      
      const p = platforms[platformIndex];
      
      // Random position on the platform with some variation
      offsetX = 30 + Math.random() * Math.max(40, p.w - 60);
      offsetY = 30 + (i % 3) * 15 + Math.random() * 20; // Vary height slightly
      
      lanterns.push({
        x: p.x + offsetX, 
        y: p.y - offsetY, 
        collected: false, 
        bob: Math.random() * Math.PI * 2
      });
    }
  }

  function startGame(){
    currentLevel = 1;
    resetGame();
    overlay.style.display='none';
    gameRunning=true;
    startBtn.textContent = 'Start Game'; // Reset button text
  }
  startBtn.addEventListener('click', startGame);

  // touch controls
  leftBtn.addEventListener('pointerdown',()=>keys.left=true);
  leftBtn.addEventListener('pointerup',()=>keys.left=false);
  leftBtn.addEventListener('pointerleave',()=>keys.left=false);
  rightBtn.addEventListener('pointerdown',()=>keys.right=true);
  rightBtn.addEventListener('pointerup',()=>keys.right=false);
  rightBtn.addEventListener('pointerleave',()=>keys.right=false);
  jumpBtn.addEventListener('pointerdown',()=>{ if(panda.onGround) { panda.vy=-16; panda.onGround=false; } });

  // keyboard
  window.addEventListener('keydown',(e)=>{
    if(e.key==='ArrowLeft' || e.key==='a') keys.left=true;
    if(e.key==='ArrowRight' || e.key==='d') keys.right=true;
    if(e.key===' ' || e.key==='ArrowUp' || e.key==='w') { if(panda.onGround){ panda.vy=-16; panda.onGround=false; } }
    if((e.key==='Enter' || e.key===' ') && !gameRunning) startGame();
  });
  window.addEventListener('keyup',(e)=>{
    if(e.key==='ArrowLeft' || e.key==='a') keys.left=false;
    if(e.key==='ArrowRight' || e.key==='d') keys.right=false;
  });

  // simple sound (beep) using WebAudio
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;
  function beep(freq=440,dur=0.08){
    if(!AudioCtx) return;
    if(!audioCtx) audioCtx = new AudioCtx();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type='sine'; o.frequency.value = freq;
    o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime+0.02);
    o.start();
    o.stop(audioCtx.currentTime+dur);
  }

  // confetti particles when win
  let confetti = [];
  function spawnConfetti(){
    for(let i=0;i<80;i++){
      confetti.push({x:W/2,y:100,vx:(Math.random()-0.5)*6,vy:Math.random()*-6-1,rot:Math.random()*360,vr:Math.random()*6-3,life:120,shape:Math.random()>0.5? 'rect':'circle'});
    }
  }

  // game loop
  let last = 0;
  function loop(t){
    const dt = Math.min(40, t-last || 16) / 16; last = t;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function update(dt){
    if(!gameRunning) return;

    // controls
    const speed = 4.6;
    if(keys.left) panda.vx = -speed;
    else if(keys.right) panda.vx = speed;
    else panda.vx *= 0.8;

    // physics
    panda.vy += gravity*dt*1.2;
    panda.x += panda.vx * dt * 14/10;
    panda.y += panda.vy * dt * 14/10;

    // tilt and eye follow
    panda.tilt = Math.max(-18, Math.min(18, panda.vx*7));
    panda.eyeOffset = Math.max(-10, Math.min(10, panda.vx*3));

    // world bounds
    if(panda.x < 20) { panda.x = 20; panda.vx=0; }
    if(panda.x > W-60) { panda.x = W-60; panda.vx=0; }
    
    // Fall detection - if panda falls off screen
    if(panda.y > H + 50) {
      // Reset position when falling off screen
      panda.x = 120; 
      panda.y = 150; 
      panda.vx = 0; 
      panda.vy = 0;
      beep(200, 0.3); // Low beep for falling
    }

    // platform collision
    panda.onGround = false;
    for(const p of platforms){
      if(panda.y + panda.h/2 > p.y && panda.y + panda.h/2 < p.y + 30 && panda.x + panda.w/2 > p.x && panda.x - panda.w/2 < p.x + p.w){
        panda.y = p.y - panda.h/2;
        panda.vy = 0;
        panda.onGround = true;
      }
    }

    // collect lanterns
    for(const L of lanterns){
      L.bob += 0.06*dt;
      L.y += Math.sin(L.bob) * 0.2;
      if(!L.collected){
        const dx = (panda.x + panda.w/2) - L.x;
        const dy = (panda.y + panda.h/2) - L.y;
        if(Math.hypot(dx,dy) < 68){
          L.collected = true; score++;
          scoreEl.textContent = score;
          beep(880 - score*40, 0.06);
          // happy bounce
          panda.vy = -8;
          if(score >= lanterns.length){
            // Level complete! Advance to next level
            currentLevel++;
            spawnConfetti();
            
            // Brief pause before next level
            setTimeout(() => {
              // Show level complete message briefly
              overlay.style.display = 'block';
              overlay.querySelector('h2').textContent = `Level ${currentLevel - 1} Complete!`;
              overlay.querySelector('div').textContent = `Great job! Starting Level ${currentLevel}...`;
              startBtn.style.display = 'none'; // Hide start button during transition
              
              // Auto-advance to next level after 2 seconds
              setTimeout(() => {
                overlay.style.display = 'none';
                startBtn.style.display = 'block'; // Show start button again
                resetGame(); // This will generate the new level
              }, 2000);
            }, 800);
          }
        }
      }
    }

    // confetti physics
    confetti.forEach(c=>{ c.vy += 0.3; c.x += c.vx; c.y += c.vy; c.rot += c.vr; c.life--; });
    confetti = confetti.filter(c=>c.life>0 && c.y < H + 50);
  }

  // drawing helpers
  function drawRoundRect(x,y,w,h,r){
    ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.fill();
  }

  function render(){
    // background sky gradient
    ctx.clearRect(0,0,W,H);
    const grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0,'#dff7ff'); grad.addColorStop(1,'#f4fff5');
    ctx.fillStyle = grad; ctx.fillRect(0,0,W,H);

    // distant mountains (asia style) - simple shapes
    drawMountain(40, H-180, 220, '#9fc6b7', '#6fa68f');
    drawMountain(240, H-220, 300, '#b9dccd', '#88c2a7');
    drawMountain(560, H-200, 260, '#a7d2c0', '#6eb68e');

    // cherry blossom clouds / lanterns in bg
    for(let i=0;i<5;i++){
      const x = 80 + i*160 + Math.sin(Date.now()/600 + i)*12;
      ctx.beginPath(); ctx.fillStyle = 'rgba(255,220,235,0.12)'; ctx.arc(x,90,40,0,Math.PI*2); ctx.fill();
    }

    // bamboo foreground
    for(let i=0;i<6;i++){
      const bx = i*140 + 20;
      drawBamboo(bx,H-80, H);
    }

    // platforms
    for(const p of platforms){
      ctx.fillStyle='rgba(60,40,20,0.06)'; drawRoundRect(p.x,p.y,p.w,p.h,8);
      // grass edge
      ctx.fillStyle='#7bb26b'; ctx.fillRect(p.x, p.y-10, p.w, 10);
    }

    // lanterns
    for(const L of lanterns){
      if(L.collected) continue;
      drawLantern(L.x, L.y);
    }

    // panda (cute cartoon)
    drawPanda(panda.x, panda.y, panda.w, panda.h, panda.tilt, panda.eyeOffset);

    // confetti
    confetti.forEach(c=>{
      ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.rot*Math.PI/180);
      if(c.shape==='rect') ctx.fillRect(-4,-6,8,12); else { ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fill(); }
      ctx.restore();
    });

    // simple HUD hint when game paused
    if(!gameRunning && overlay.style.display==='none'){
      ctx.fillStyle='rgba(0,0,0,0.06)'; ctx.fillRect(10, H-50, 220, 40);
      ctx.fillStyle='#063'; ctx.font='16px system-ui'; ctx.fillText('Tap Enter or Start to play again', 20, H-22);
    }
  }

  // draw objects
  function drawMountain(x,y,w,base,shade){
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x + w*0.5, y - (w*0.4)); ctx.lineTo(x + w, y); ctx.closePath();
    ctx.fillStyle = base; ctx.fill();
    ctx.beginPath(); ctx.moveTo(x + w*0.5, y - (w*0.4)); ctx.lineTo(x + w*0.65, y - (w*0.22)); ctx.lineTo(x + w*0.35, y - (w*0.22)); ctx.closePath();
    ctx.fillStyle = shade; ctx.fill();
  }

  function drawBamboo(x, groundY, canvasH){
    const h = 180 + (x%3)*10;
    ctx.fillStyle='#166'; ctx.fillRect(x, groundY - h, 10, h);
    ctx.fillStyle='#0a4'; ctx.fillRect(x+10, groundY - h + 20, 6, h-20);
    // leaves
    ctx.beginPath(); ctx.fillStyle='rgba(10,80,30,0.9)'; ctx.ellipse(x-8, groundY - h + 40, 24, 8, -0.2, 0, Math.PI*2); ctx.fill();
  }

  function drawLantern(x,y){
    ctx.save(); ctx.translate(x,y);
    // string
    ctx.strokeStyle='#6b2b00'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,-28); ctx.lineTo(0,-14); ctx.stroke();
    // body
    ctx.beginPath(); ctx.ellipse(0,0,18,24,0,0,Math.PI*2); ctx.fillStyle='#ff795e'; ctx.fill();
    ctx.beginPath(); ctx.ellipse(0,0,14,20,0,0,Math.PI*2); ctx.fillStyle='#ffb7a1'; ctx.fill();
    // tassel
    ctx.fillStyle='#5a1b00'; ctx.fillRect(-6,20,12,8);
    ctx.restore();
  }

  function drawPanda(x,y,w,h,tilt,eyeOffset){
    ctx.save();
    ctx.translate(x + w/2, y + h/2);
    ctx.rotate(tilt * Math.PI/180);

    // body shadow
    ctx.beginPath(); ctx.ellipse(0,h*0.18,w*0.48,w*0.26,0,0,Math.PI*2); ctx.fillStyle='rgba(0,0,0,0.06)'; ctx.fill();

    // tummy
    ctx.beginPath(); ctx.fillStyle='#fff'; ctx.ellipse(0,6,w*0.38,h*0.45,0,0,Math.PI*2); ctx.fill();

    // arms
    ctx.beginPath(); ctx.fillStyle='#111'; ctx.ellipse(-w*0.42,8,w*0.18,h*0.22,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(w*0.42,8,w*0.18,h*0.22,0,0,Math.PI*2); ctx.fill();

    // head
    ctx.beginPath(); ctx.fillStyle='#fff'; ctx.ellipse(0,-h*0.16,w*0.42,h*0.46,0,0,Math.PI*2); ctx.fill();
    // ears
    ctx.beginPath(); ctx.fillStyle='#111'; ctx.arc(-w*0.28,-h*0.4, w*0.12,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(w*0.28,-h*0.4, w*0.12,0,Math.PI*2); ctx.fill();

    // eye patches
    ctx.beginPath(); ctx.fillStyle='#111'; ctx.ellipse(-w*0.12,-h*0.18,w*0.15,h*0.12,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(w*0.12,-h*0.18,w*0.15,h*0.12,0,0,Math.PI*2); ctx.fill();

    // eyes (white) and pupils that follow movement
    ctx.beginPath(); ctx.fillStyle='#fff'; ctx.arc(-w*0.12,-h*0.18, w*0.06,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.fillStyle='#fff'; ctx.arc(w*0.12,-h*0.18, w*0.06,0,Math.PI*2); ctx.fill();

    ctx.beginPath(); ctx.fillStyle='#000'; ctx.arc(-w*0.12 + eyeOffset*0.9/3, -h*0.18, w*0.03,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.fillStyle='#000'; ctx.arc(w*0.12 + eyeOffset*0.9/3, -h*0.18, w*0.03,0,Math.PI*2); ctx.fill();

    // little nose and smile
    ctx.beginPath(); ctx.fillStyle='#000'; ctx.ellipse(0,-h*0.08, w*0.045, h*0.03,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.strokeStyle='#6b3'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,-h*0.03, w*0.08, 0, Math.PI); ctx.stroke();

    ctx.restore();
  }

  // initial overlay text
  overlay.querySelector('h2').textContent = 'Silly Bamboo Collect';
  overlay.querySelector('div').textContent = 'A silly panda wants lanterns! Move with arrow keys or the big buttons. Each level has more lanterns to collect!';

  // set initial panda y using platforms
  panda.y = platforms && platforms.length? platforms[0].y - panda.h/2 : H/2;

  // friendly hint to let parents know controls
  if(isTouch) overlay.querySelector('div').textContent += ' (Touch controls enabled)';

  // click canvas to focus and nudge audio context
  canvas.addEventListener('pointerdown', ()=>{ if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); });

  // back button functionality
  backBtn.addEventListener('click', () => {
    window.location.href = 'home.html';
  });

  // start paused
  gameRunning=false;
})();
</script>
</body>
</html>
